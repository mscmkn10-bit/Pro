<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Property Registration</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  form { display: grid; gap: 10px; max-width: 600px; margin-bottom: 20px; }
  input, select, button { padding: 8px; font-size: 14px; width: 100%; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
</style>
</head>
<body>

<h2>Property Registration</h2>

<label>Select Date: <input type="date" id="datePicker"></label>
<button id="loadDateBtn">Load Date</button>
<button id="downloadCSV">Download CSV</button>

<form id="propertyForm">
  <input type="text" name="State" placeholder="State" required>
  <input type="text" name="District" placeholder="District" required>
  <input type="text" name="Document" placeholder="Document">
  <input type="text" name="Document Number" placeholder="Document Number">
  <input type="text" name="Docs Presentation" placeholder="Docs Presentation">
  <input type="text" name="Executer Name" placeholder="Executer Name">
  <input type="text" name="Favor of Name" placeholder="Favor of Name">
  <input type="text" name="SRO Name" placeholder="SRO Name">
  <input type="text" name="Client Name / Source" placeholder="Client Name / Source">
  <input type="text" name="Drafted and Executed" placeholder="Drafted and Executed">
  <input type="text" name="Property Address" placeholder="Property Address">
  <input type="number" name="Consideration Price" placeholder="Consideration Price">
  <input type="text" name="SI / CSI" placeholder="SI / CSI">
  <input type="number" name="Registration" placeholder="Registration">
  <input type="number" name="Stamp Duty" placeholder="Stamp Duty">
  <input type="number" name="Society Duty" placeholder="Society Duty">
  <input type="number" name="Total" placeholder="Total">
  <input type="text" name="Commission Of" placeholder="Commission Of">
  <input type="number" name="Remaining Amount" placeholder="Remaining Amount">
  <input type="number" name="SRO Expenses" placeholder="SRO Expenses">
  <input type="number" name="Final Amount Submission" placeholder="Final Amount Submission">
  <input type="text" name="SFDC" placeholder="SFDC">
  <button type="submit">Submit</button>
</form>

<table id="dataTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwxz6tgSPwM6mGW3YzXhM52TiZfWMDceZ-FiO8KgzCltDCZ057EbA9jeH3HWHhwMdTi/exec"; // replace with your Apps Script URL

let allData = [];

// Load data from localStorage for today
const today = new Date().toISOString().split('T')[0];
const stored = localStorage.getItem(today);
if (stored) {
  allData = JSON.parse(stored);
  renderTable(allData);
}

document.getElementById("propertyForm").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const obj = {};
  formData.forEach((v,k) => obj[k]=v);
  
  // Save to localStorage
  allData.push(obj);
  localStorage.setItem(today, JSON.stringify(allData));
  
  // Render table instantly
  renderTable(allData);
  
  // Send to Google Sheets
  await fetch(WEB_APP_URL, {
    method: "POST",
    body: JSON.stringify(obj)
  }).catch(err => console.error(err));
  
  e.target.reset();
});

document.getElementById("loadDateBtn").addEventListener("click", async () => {
  const date = document.getElementById("datePicker").value;
  if (!date) return alert("Select a date");
  const res = await fetch(`${WEB_APP_URL}?date=${date}`);
  const data = await res.json();
  allData = data;
  renderTable(allData);
});

document.getElementById("downloadCSV").addEventListener("click", () => {
  if (!allData.length) return alert("No data to download");
  const keys = Object.keys(allData[0]);
  const csv = [
    keys.join(","),
    ...allData.map(row => keys.map(k => `"${row[k]||''}"`).join(","))
  ].join("\n");
  
  const blob = new Blob([csv], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "property_data.csv";
  a.click();
  URL.revokeObjectURL(url);
});

function renderTable(data) {
  const table = document.getElementById("dataTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";
  if (!data.length) return;
  
  const headers = Object.keys(data[0]);
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "</tr>";
  tbody.innerHTML = data.map(row => 
    "<tr>" + headers.map(h => `<td>${row[h]||''}</td>`).join("") + "</tr>"
  ).join("");
}
</script>

</body>
</html>
