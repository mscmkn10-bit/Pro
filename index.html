<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registry Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; margin-bottom: 20px; }
        .card-header { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; border-radius: 12px 12px 0 0 !important; font-weight: bold; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #555; }
        .total-box { background-color: #e9ecef; border: 1px solid #ced4da; font-weight: bold; color: #0d6efd; }
        .btn-custom { border-radius: 8px; font-weight: 600; padding: 10px 20px; }
        table { font-size: 0.9rem; }
        thead { background-color: #0d6efd; color: white; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header"><i class="fas fa-file-invoice me-2"></i>New Entry</div>
                <div class="card-body">
                    <form id="registryForm">
                        <div class="row g-2">
                            <div class="col-6"><label class="form-label">State</label><input type="text" class="form-control" name="State" required></div>
                            <div class="col-6"><label class="form-label">District</label><input type="text" class="form-control" name="District" required></div>
                            <div class="col-12"><label class="form-label">Party Name</label><input type="text" class="form-control" name="Party Name" required></div>
                            <div class="col-6"><label class="form-label">Bank Name</label><input type="text" class="form-control" name="Bank Name"></div>
                            <div class="col-6"><label class="form-label">Executor Name</label><input type="text" class="form-control" name="Executor Name"></div>
                            <div class="col-12"><label class="form-label">Phone Number</label><input type="number" class="form-control" name="Phone"></div>
                            
                            <hr class="my-3">
                            
                            <div class="col-6"><label class="form-label">Registry Amount</label><input type="number" class="form-control" name="Registry Amount"></div>
                            <div class="col-6"><label class="form-label">Society Duty</label><input type="number" class="form-control" name="Society Duty"></div>
                            <div class="col-6"><label class="form-label">Registration Fees</label><input type="number" class="form-control" name="Reg Fees"></div>
                            <div class="col-6"><label class="form-label">SC/CSI</label><input type="number" class="form-control" name="SC/CSI"></div>
                            
                            <div class="col-12 bg-light p-2 border rounded mt-2">
                                <h6 class="text-primary border-bottom pb-1">Calculation Section</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label">Per Challan Total</label>
                                        <input type="number" class="form-control" id="totalFees" name="Per Challan Total" required>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Sales Person Fees</label>
                                        <input type="number" class="form-control" id="salesFees" name="Sales Person Fees" required>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">SRO Expenses</label>
                                        <input type="number" class="form-control" id="sroExp" name="SRO Expenses">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Office Fees (Auto)</label>
                                        <input type="number" class="form-control total-box" id="officeFees" name="Office Fees" readonly>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-success">Amount Submission (Final)</label>
                                        <input type="number" class="form-control total-box" id="amtSub" name="Amount Submission" readonly>
                                        <small class="text-muted" style="font-size: 0.75rem;">(Office Fees + SRO Expenses)</small>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 mt-3">
                                <button type="submit" class="btn btn-primary w-100 btn-custom"><i class="fas fa-save me-2"></i>Submit & Save</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-database me-2"></i>Records (Date Wise)</span>
                    <button class="btn btn-light btn-sm text-primary fw-bold" onclick="syncWithGoogleSheet()">
                        <i class="fas fa-sync-alt me-1"></i> Fetch from Excel
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-2 mb-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">From Date</label>
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">To Date</label>
                            <input type="date" id="endDate" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-secondary w-100" onclick="filterData()">Filter</button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-danger w-100" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success w-100" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Excel</button>
                        </div>
                    </div>

                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-bordered table-hover table-striped" id="dataTable">
                            <thead class="position-sticky top-0">
                                <tr>
                                    <th>Date</th>
                                    <th>Party Name</th>
                                    <th>Total Fees</th>
                                    <th>Sales Fees</th>
                                    <th>Office Fees</th>
                                    <th>SRO Exp</th>
                                    <th>Submission</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    // **********************************************
    // CONFIGURATION
    // **********************************************
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdQXBMEQ1wSRIMx_9m80S97VX45O4bUGq5FgEePSQg59wt2xZ8VS8fDa_pxakH2Fmu/exec'; // यहाँ अपना Google App Script URL पेस्ट करें
    // **********************************************

    const form = document.getElementById('registryForm');
    const tableBody = document.getElementById('tableBody');
    const loader = document.getElementById('loader');

    // 1. Live Calculation Logic
    const calcInputs = ['totalFees', 'salesFees', 'sroExp'];
    calcInputs.forEach(id => {
        document.getElementById(id).addEventListener('input', calculateValues);
    });

    function calculateValues() {
        const total = parseFloat(document.getElementById('totalFees').value) || 0;
        const sales = parseFloat(document.getElementById('salesFees').value) || 0;
        const sro = parseFloat(document.getElementById('sroExp').value) || 0;

        // Logic 1: Office Fees = Total - Sales
        const officeFees = total - sales;
        document.getElementById('officeFees').value = officeFees;

        // Logic 2: Amount Submission (User Requirement: Minus SRO from Sales, Add to Submission)
        // Interpretation: Sales person gets (Sales - SRO). The deducted SRO amount goes to Office submission.
        // So, Submission = Office Fees + SRO.
        const submission = officeFees + sro;
        document.getElementById('amtSub').value = submission;
    }

    // 2. Load Data on Startup
    window.addEventListener('load', () => {
        loadFromLocal();
        // Set date inputs to current month for convenience
        const date = new Date();
        document.getElementById('startDate').value = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        document.getElementById('endDate').value = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().split('T')[0];
    });

    // 3. Form Submission
    form.addEventListener('submit', e => {
        e.preventDefault();
        loader.style.display = 'flex';

        const formData = new FormData(form);
        const dataObj = {};
        
        // Convert FormData to Object
        formData.forEach((value, key) => dataObj[key] = value);
        
        // Add Date explicitly for sorting
        const today = new Date();
        dataObj['Date'] = today.toISOString().split('T')[0]; // YYYY-MM-DD format

        // A. Save to LocalStorage immediately
        saveToLocal(dataObj);

        // B. Send to Google Sheets (Backend)
        fetch(SCRIPT_URL, {
            method: 'POST',
            body: new URLSearchParams(dataObj)
        })
        .then(response => response.json())
        .then(response => {
            console.log('Saved to Sheet:', response);
            alert("Data Saved Successfully to Backend & Browser!");
            form.reset();
            calculateValues(); // Reset calculations
            loader.style.display = 'none';
        })
        .catch(error => {
            console.error('Error!', error.message);
            alert("Saved to Browser only. Internet Issue with Sheet.");
            loader.style.display = 'none';
            form.reset();
        });
    });

    // 4. LocalStorage Handling
    function saveToLocal(data) {
        let records = JSON.parse(localStorage.getItem('registryData')) || [];
        records.push(data);
        localStorage.setItem('registryData', JSON.stringify(records));
        renderTable(records);
    }

    function loadFromLocal() {
        let records = JSON.parse(localStorage.getItem('registryData')) || [];
        renderTable(records);
    }

    // 5. Fetch from Google Sheets (Sync Button)
    function syncWithGoogleSheet() {
        loader.style.display = 'flex';
        fetch(SCRIPT_URL + "?action=read")
        .then(res => res.json())
        .then(json => {
            if(json.status === 'success') {
                // Convert Google Sheet Date format to YYYY-MM-DD
                const cleanData = json.data.map(item => {
                    if(item.Date) {
                        let d = new Date(item.Date);
                        item.Date = d.toISOString().split('T')[0];
                    }
                    return item;
                });
                
                // Update LocalStorage with Sheet Data (Master Copy)
                localStorage.setItem('registryData', JSON.stringify(cleanData));
                renderTable(cleanData);
                alert("Data synced with Excel successfully!");
            }
            loader.style.display = 'none';
        })
        .catch(e => {
            alert("Error fetching data");
            loader.style.display = 'none';
        });
    }

    // 6. Render Table
    function renderTable(data) {
        tableBody.innerHTML = '';
        // Sort by Date (Newest first)
        data.sort((a, b) => new Date(b.Date) - new Date(a.Date));

        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.Date || ''}</td>
                <td class="fw-bold">${row['Party Name'] || ''}</td>
                <td>${row['Per Challan Total'] || 0}</td>
                <td>${row['Sales Person Fees'] || 0}</td>
                <td>${row['Office Fees'] || 0}</td>
                <td>${row['SRO Expenses'] || 0}</td>
                <td class="text-success fw-bold">${row['Amount Submission'] || 0}</td>
                <td><button class="btn btn-sm btn-info text-white" onclick='showFullDetails(${JSON.stringify(row)})'>View</button></td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function showFullDetails(data) {
        let details = "";
        for (const [key, value] of Object.entries(data)) {
            details += `${key}: ${value}\n`;
        }
        alert(details);
    }

    // 7. Filter Logic
    function filterData() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        let records = JSON.parse(localStorage.getItem('registryData')) || [];

        if (start && end) {
            records = records.filter(item => {
                return item.Date >= start && item.Date <= end;
            });
        }
        renderTable(records);
    }

    // 8. Export to Excel
    function exportExcel() {
        let data = getCurrentTableData();
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "RegistryData");
        XLSX.writeFile(wb, "Registry_Data.xlsx");
    }

    // 9. Export to PDF
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let data = getCurrentTableData();
        
        // Prepare data for autotable
        const tableColumn = ["Date", "Party", "District", "Total Fees", "Sales Fees", "Office Fees", "Submission"];
        const tableRows = [];

        data.forEach(row => {
            const rowData = [
                row.Date,
                row['Party Name'],
                row['District'],
                row['Per Challan Total'],
                row['Sales Person Fees'],
                row['Office Fees'],
                row['Amount Submission']
            ];
            tableRows.push(rowData);
        });

        doc.text("Registry Report", 14, 15);
        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 20,
        });
        doc.save("Registry_Report.pdf");
    }

    // Helper to get currently displayed data for export
    function getCurrentTableData() {
        // Logic: Filter again based on current inputs to ensure what user sees is what they get
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        let records = JSON.parse(localStorage.getItem('registryData')) || [];
        
        if (start && end) {
            records = records.filter(item => item.Date >= start && item.Date <= end);
        }
        // Sort
        records.sort((a, b) => new Date(b.Date) - new Date(a.Date));
        return records;
    }
</script>

</body>
</html>
