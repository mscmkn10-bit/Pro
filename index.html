<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Registration Pro - Range Filter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .main-card { border: none; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); background: white; }
        .form-section { border-right: 1px solid #eee; padding: 25px; }
        .table-section { padding: 25px; }
        .btn-primary { background: #4e73df; border: none; }
        .table-container { height: 70vh; overflow-y: auto; font-size: 0.85rem; }
        .sticky-thead th { position: sticky; top: 0; background: #f8f9fc; z-index: 5; border-top: none; }
    </style>
</head>
<body>

<div class="container-fluid py-4">
    <div class="main-card">
        <div class="row g-0">
            <div class="col-lg-4 form-section">
                <h4 class="mb-4 text-primary">Property Entry</h4>
                <form id="regForm" class="row g-3">
                    <div class="col-6"><label class="form-label">State</label><input type="text" name="State" class="form-control" required></div>
                    <div class="col-6"><label class="form-label">District</label><input type="text" name="District" class="form-control" required></div>
                    <div class="col-6"><label class="form-label">Document</label><input type="text" name="Document" class="form-control"></div>
                    <div class="col-6"><label class="form-label">Doc Number</label><input type="text" name="DocumentNumber" class="form-control"></div>
                    <div class="col-12"><label class="form-label">Client Name / Source</label><input type="text" name="ClientName" class="form-control"></div>
                    <div class="col-12"><label class="form-label">Property Address</label><textarea name="PropertyAddress" class="form-control" rows="2"></textarea></div>
                    
                    <div class="col-4"><label class="form-label">Stamp Duty</label><input type="number" name="StampDuty" class="form-control calc" value="0"></div>
                    <div class="col-4"><label class="form-label">Registration</label><input type="number" name="Registration" class="form-control calc" value="0"></div>
                    <div class="col-4"><label class="form-label">Society Duty</label><input type="number" name="SocietyDuty" class="form-control calc" value="0"></div>
                    
                    <div class="col-12">
                        <div class="bg-light p-3 rounded text-center">
                            <small class="text-muted d-block">Total Amount</small>
                            <h3 id="displayTotal" class="mb-0">₹ 0</h3>
                            <input type="hidden" name="Total" id="hiddenTotal">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg mt-3">Submit & Sync</button>
                </form>
            </div>

            <div class="col-lg-8 table-section">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
                    <h4 class="mb-0">Registration Records</h4>
                    <div class="d-flex gap-2 align-items-end">
                        <div>
                            <label class="small text-muted">From</label>
                            <input type="date" id="startDate" class="form-control form-control-sm">
                        </div>
                        <div>
                            <label class="small text-muted">To</label>
                            <input type="date" id="endDate" class="form-control form-control-sm">
                        </div>
                        <button class="btn btn-sm btn-dark" onclick="fetchRange()">Filter Range</button>
                        <button class="btn btn-sm btn-outline-success" onclick="downloadCSV()">CSV</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table table-sm table-hover border">
                        <thead class="sticky-thead">
                            <tr id="tableHeaders"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwOlMde3bHVCKcZSlpv31DIlY4Weh7Ncboao9NNqq-VdZQ07HWRT01sO947GdBY1_ia/exec';
    const form = document.getElementById('regForm');

    // Load initial today's data from LocalStorage
    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        renderTable(getLocalData());
    };

    // Auto-calculate total
    document.querySelectorAll('.calc').forEach(input => {
        input.addEventListener('input', () => {
            let total = 0;
            document.querySelectorAll('.calc').forEach(i => total += (parseFloat(i.value) || 0));
            document.getElementById('displayTotal').innerText = '₹ ' + total.toLocaleString();
            document.getElementById('hiddenTotal').value = total;
        });
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        data.Timestamp = new Date().toLocaleString();

        // 1. Instant Local Update
        const local = getLocalData();
        local.unshift(data);
        localStorage.setItem('propertyEntries', JSON.stringify(local));
        renderTable(local);
        form.reset();
        document.getElementById('displayTotal').innerText = '₹ 0';

        // 2. Cloud Sync
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
        } catch (err) { console.error("Sync Error", err); }
    });

    async function fetchRange() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        if(!start || !end) return alert("Please select both dates");

        document.getElementById('tableBody').innerHTML = '<tr><td colspan="20" class="text-center">Fetching data from Cloud...</td></tr>';
        
        try {
            const res = await fetch(`${SCRIPT_URL}?start=${start}&end=${end}`);
            const data = await res.json();
            renderTable(data);
        } catch (err) {
            alert("Error fetching range. Ensure script is deployed correctly.");
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        const thead = document.getElementById('tableHeaders');
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="20" class="text-center py-5 text-muted">No records found.</td></tr>';
            return;
        }

        const keys = Object.keys(data[0]);
        thead.innerHTML = keys.map(k => `<th>${k}</th>`).join('');
        tbody.innerHTML = data.map(row => `<tr>${keys.map(k => `<td>${row[k] || ''}</td>`).join('')}</tr>`).join('');
    }

    function getLocalData() { return JSON.parse(localStorage.getItem('propertyEntries') || '[]'); }

    function downloadCSV() {
        const rows = Array.from(document.querySelectorAll('tr'));
        const csv = rows.map(r => Array.from(r.querySelectorAll('th,td')).map(c => `"${c.innerText}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Report_${document.getElementById('startDate').value}_to_${document.getElementById('endDate').value}.csv`;
        a.click();
    }
</script>

</body>
</html>
